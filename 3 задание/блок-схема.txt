@startuml Блок-схема с обработкой ошибок
title Блок-схема регистрации с акцентом на обработку ошибок

start
:Получить запрос регистрации;

partition "Фаза 1: Предварительные проверки" {
  if (JSON синтаксис корректен?) then (Да)
    if (Все обязательные поля есть?) then (Да)
      if (acceptTerms == true?) then (Да)
        :Перейти к валидации данных;
      else (Нет)
        :Ошибка: TERMS_NOT_ACCEPTED;
      endif
    else (Нет)
      :Ошибка: MISSING_REQUIRED_FIELD;
    endif
  else (Нет)
    :Ошибка: INVALID_JSON;
  endif
}

->Ошибка?;
if (Ошибка на этапе 1?) then (Да)
  :Вернуть 400 с кодом ошибки;
  stop
else (Нет)
  :Продолжить;
endif

partition "Фаза 2: Валидация данных" {
  :Валидация email;
  if (Email валиден?) then (Нет)
    :Ошибка: EMAIL_INVALID;
    ->Ошибка?;
  else (Да)
    :Валидация пароля;
    if (Пароль валиден?) then (Нет)
      :Ошибка: PASSWORD_TOO_WEAK;
      ->Ошибка?;
    else (Да)
      :Валидация имени;
      if (Имя валидно?) then (Нет)
        :Ошибка: NAME_INVALID;
        ->Ошибка?;
      else (Да)
        :Перейти к проверке в БД;
      endif
    endif
  endif
}

if (Ошибка на этапе 2?) then (Да)
  :Вернуть 400 с кодом ошибки;
  stop
else (Нет)
  :Продолжить;
endif

partition "Фаза 3: Проверки в БД" {
  :Проверить rate limiting;
  if (Лимит превышен?) then (Да)
    :Ошибка: RATE_LIMIT_EXCEEDED;
    ->Ошибка?;
  else (Нет)
    :Проверить email в БД;
    if (Email существует?) then (Да)
      :Ошибка: EMAIL_ALREADY_EXISTS;
      ->Ошибка?;
    else (Нет)
      :Проверить телефон в БД;
      if (Телефон существует?) then (Да)
        :Ошибка: PHONE_ALREADY_EXISTS;
        ->Ошибка?;
      else (Нет)
        :Создать пользователя;
      endif
    endif
  endif
}

if (Ошибка на этапе 3?) then (Да)
  if (Ошибка == RATE_LIMIT_EXCEEDED) then (Да)
    :Вернуть 429;
  else (Нет)
    :Вернуть 400;
  endif
  stop
else (Нет)
  :Пользователь создан успешно;
endif

partition "Фаза 4: Постобработка" {
  :Сгенерировать токены;
  :Отправить verification email;
  :Записать в лог;
  :Отправить в аналитику;
  
  :Вернуть 200 OK\nс данными пользователя;
}

stop

@enduml